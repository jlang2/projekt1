<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="https://unpkg.com/react@16.9.0/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16.9.0/umd/react-dom.development.js"></script>
	<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
	<script src="resurs.js"></script>
	<link rel="stylesheet" href="style.css" type="text/css" charset="utf-8">
</head>
<body>
<div id="root"></div>
	
<script type="text/babel">

	let jsonDataText;
	let kursSwitch = 0;

	function updateState(isUndefined) {
		isUndefined = true;
    	this.setState({isUndefined});
	}

	function handleUpdate() {
		this.forceUpdate();
	}

	function handleUpdateKaks() {
		this.forceUpdate();
	}

	function handleUpdateKolme() {
		this.forceUpdate();
	}

  	class SelectContainer extends React.Component {
		constructor() {
			super()
			this.state = {
        		isHidden: true
			}
		}
		
		toggleHidden() {
			if(kursSwitch == 0) {
				kursSwitch = 1;
			} else {
				kursSwitch = 0;
			}
			this.setState({
        		isHidden: !this.state.isHidden
			})
      }
      
		render() {
			return (
        		<div>
          			<select id="category" name="category" onChange={this.toggleHidden.bind(this)}>
						<option value="BDA">BDA</option>
						<option value="IT-Bachelor">IT-Bachelor</option>					
					</select>
          			{this.state.isHidden && <BDAKurser />}
					{!this.state.isHidden && <IAKurser />}
					<Personal />
					<Send />
				</div>
			)
		}
    }

	class BDAKurser extends React.Component {
		constructor() {
			super()
			if (localStorage.getItem("jsondata") != null) {
				jsonDataText = localStorage.getItem("jsondata");
				jsondata = JSON.parse(jsonDataText);
			}
			handleUpdateKaks = handleUpdateKaks.bind(this)
		}

		render() {
			return (
				<select id="kurserSelect">
					{
						jsondata.Program.BDA.Kurser.map((bdakurser, i) => {
							for(let counter = 0; counter < jsondata.active.length; counter++) {
								if(jsondata.active[counter].Kurs == bdakurser.namn) { // checkar om kursen redan är vald
									return; // isåfall renderera inte
								}
							}
							return (
								<option key={i} value={bdakurser.namn + "+" + bdakurser.kurskod + "+" + bdakurser.timmar + "+" + bdakurser.period }>{bdakurser.namn + " " + bdakurser.kurskod}</option>
							);
						})
					}
				</select>
			);
		}
    }
 

	class IAKurser extends React.Component {

		constructor() {
			super()
			if (localStorage.getItem("jsondata") != null) {
				jsonDataText = localStorage.getItem("jsondata");
				jsondata = JSON.parse(jsonDataText);
			}
			handleUpdateKolme = handleUpdateKolme.bind(this)
		}

		render() {
			return (
				<select id="kurserSelect">
					{
						jsondata.Program.IA.Kurser.map((iakurser, i) => {
							for(let counter = 0; counter < jsondata.active.length; counter++) {
								if(jsondata.active[counter].Kurs == iakurser.namn) { // checkar om kursen redan är vald
									return; // isåfall renderera inte
								}
							}
							return (
								<option key={i} value={iakurser.namn + "+" + iakurser.kurskod + "+" + iakurser.timmar + "+" + iakurser.period }>{iakurser.namn + " " + iakurser.kurskod}</option>
							);
						})
					}
				</select>
			);
		}
	}
	
	class Personal extends React.Component {
		constructor() {
			super()
			if (localStorage.getItem("jsondata") != null) {
				jsonDataText = localStorage.getItem("jsondata");
				jsondata = JSON.parse(jsonDataText);
			}
		}
		render() {
			return (
				<select id="personalSelect">
					{
						jsondata.Personal.map((person, i) => {
							return (
								<option key={i} value={person.Förnamn + " " + person.Efternamn}>{person.Förnamn + " " + person.Efternamn}</option>
							);	
						})
					}
				</select>
			);
		}
	}

	class Send extends React.Component {
		constructor() {
			super();
			this.dataToJson = this.dataToJson.bind(this);
		}
		
		dataToJson() {
			const kursArray = kurserSelect.value.split("+");
			const lektorNamn = personalSelect.value;

			if(jsondata.active[0] == undefined) {

				for(let i = 0; i < jsondata.Personal.length; i++) {
					let namn = jsondata.Personal[i].Förnamn + " " + jsondata.Personal[i].Efternamn;
					if(namn == lektorNamn) {
						jsondata.Personal[i].Timmar = 100;
						jsondata.Personal[i].Kursantal = 1;
					}
				}

				jsondata.active = [{
					Lektor: lektorNamn,            
					Kurs: kursArray[0],
					Kurskod: kursArray[1],
					Timmar: kursArray[2],
					Period: kursArray[3]
				}];

			} else {
				for(let i = 0; i < jsondata.active.length; i++) {

					if(jsondata.active[i].Kurs == kursArray[0]) {
						alert("Någon har redan valt denna kurs.");
						return;
					}
				}

				for(let i = 0; i < jsondata.Personal.length; i++) {
					let namn = jsondata.Personal[i].Förnamn + " " + jsondata.Personal[i].Efternamn;
					if(namn == lektorNamn) {
						if(jsondata.Personal[i].Timmar >= 1600 || jsondata.Personal[i].Kursantal >= 11) { // timantal och kursantal check
							alert(namn + " har redan maximala antal kurser/timmar.");
							return;
						} else {
							if(jsondata.Personal[i].Timmar == undefined) {
								jsondata.Personal[i].Timmar = 100;
								jsondata.Personal[i].Kursantal = 1;
							} else {
								jsondata.Personal[i].Timmar += 100;
								jsondata.Personal[i].Kursantal++;
							}
						}
					}
				}

				jsondata.active.push({
					Lektor: lektorNamn,
					Kurs: kursArray[0],
					Kurskod: kursArray[1],
					Timmar: kursArray[2],
					Period: kursArray[3]
				});
			}
		jsonDataText = JSON.stringify(jsondata);
		localStorage.setItem("jsondata", jsonDataText);
		}

		wrapperFunction = () => {
			this.dataToJson();
			updateState();
			handleUpdate();
			if(kursSwitch == 0) {
				handleUpdateKaks();
			} else {
				handleUpdateKolme();
			}
		}
			
			render() {
				return (
					<input type="button" name="button" id="button" onClick={this.wrapperFunction} value="Skicka"></input>
				);
			}
    }
	

    
	class TableData extends React.Component {
		constructor() {
			super()
				if (localStorage.getItem("jsondata") != null) {
					jsonDataText = localStorage.getItem("jsondata");
					jsondata = JSON.parse(jsonDataText);
				}
			this.deleteRow = this.deleteRow.bind(this);
		}

		wrapperFunction = () => {
			this.deleteRow(event);
			handleUpdate();
			if(kursSwitch == 0) {
				handleUpdateKaks();
			} else {
				handleUpdateKolme();
			}
		}


		deleteRow(event) { // funktion för att ta bort rader
			let timmar;
			const id = event.target.id; // tar id för knappen man tryckt på
			const element = document.getElementById(id);
			const row = element.parentElement.parentElement.children;
			const lektor = row[0].firstChild.data; // data som visas i tabellen
			const kurs = row[1].firstChild.data; // data som visas i tabellen
			for(let i = 0; i < jsondata.active.length; i++) { // loop för att hitta värdet i jsondata.active som korresponderar med värdet i tabellen
				if(jsondata.active[i].Kurs == kurs) {
					timmar = jsondata.active[i].Timmar; // 1.0. sparar timmar för kursen i variabel
					jsondata.active.splice(i, 1); // tar bort värde ur jsondata.active vid position i
				}
			}
			for(let i = 0; i < jsondata.Personal.length; i++) { // loop för att hitta namnet i jsondata.Personal som korresponderar med namnet i tabellen
						let namn = jsondata.Personal[i].Förnamn + " " + jsondata.Personal[i].Efternamn;
						if(namn == lektor) { // const lektor = row[0].firstChild.data;
							jsondata.Personal[i].Timmar -= timmar; // 1.1. tar bort timmar för kursen i 1.0. från timantalet
							jsondata.Personal[i].Kursantal--;
						}
					}
			jsonDataText = JSON.stringify(jsondata);
			localStorage.setItem("jsondata", jsonDataText);
			this.forceUpdate();
		}

		render () {
			return (
				jsondata.active.map((x, i) => {
					let id = "row" + i;
					let remove = "remove" + i;
					if (x.Period == 1){
						return (
							<tr key={i} id={id}>
								<td>{x.Lektor}</td>
								<td>{x.Kurs}</td>
								<td>{x.Kurskod}</td>
								<td>1</td>
								<td><input type="button" name="button" id={remove} onClick={this.wrapperFunction} value="X"></input></td>
							</tr>
						);
					}
			
							
					if (x.Period == 2){
						return (
							<tr key={i} id={id}>
								<td>{x.Lektor}</td>
								<td>{x.Kurs}</td>
								<td>{x.Kurskod}</td>
								<td>2</td>
								<td><input type="button" name="button" id={remove} onClick={this.wrapperFunction} value="X"></input></td>
							</tr>
						);
					}

					if (x.Period == 3){
						return (
							<tr key={i} id={id}>
								<td>{x.Lektor}</td>
								<td>{x.Kurs}</td>
								<td>{x.Kurskod}</td>
								<td>3</td>
								<td><input type="button" name="button" id={remove} onClick={this.wrapperFunction} value="X"></input></td>
							</tr>
						);
					} else {
						return (
							<tr key={i} id={id}>
								<td>{x.Lektor}</td>
								<td>{x.Kurs}</td>
								<td>{x.Kurskod}</td>
								<td>4</td>
								<td><input type="button" name="button" id={remove} onClick={this.wrapperFunction} value="X"></input></td>
							</tr>
						);
					}
				})	
			)
		}
	}

	class HourTableData extends React.Component {
		constructor() {
			super()
				if (localStorage.getItem("jsondata") != null) {
					jsonDataText = localStorage.getItem("jsondata");
					jsondata = JSON.parse(jsonDataText);
				}
		}

		render () {
			return (
				jsondata.Personal.map((x, i) => {
					if(x.Timmar != undefined && x.Timmar != 0) {
					return (
						<tr key={i}>
							<td>{x.Förnamn + " " + x.Efternamn}</td>
							<td>{x.Timmar + "h"}</td>
							<td>{x.Kursantal}</td>
						</tr>
					);
					}
				})
			)
		}
	}

	class HourTable extends React.Component {

		constructor(props) {
			super(props)
			if (localStorage.getItem("jsondata") != null) {
				jsonDataText = localStorage.getItem("jsondata");
				jsondata = JSON.parse(jsonDataText);
			} else {
				jsondata.active = new Object();
			}
			handleUpdate = handleUpdate.bind(this)
		}

		render () {
			return (
				<table> 
					<tbody>
						<tr>
							<th>Lektor</th>
							<th>Timantal</th>
							<th>Kursantal</th>
						</tr>
						<HourTableData />
					</tbody>
				</table>
			)
		}
	}
   
	// kurser
	class Table extends React.Component {
		constructor(props) {
			super(props)
			if (localStorage.getItem("jsondata") != null) {
				jsonDataText = localStorage.getItem("jsondata");
				jsondata = JSON.parse(jsonDataText);
			} else {
				jsondata.active = new Object();
			}

			if(jsondata.active[0] == undefined) {
				this.state = {
					isUndefined: false
				}
			} else {
				this.state = {
					isUndefined: true
				}
			}
			updateState = updateState.bind(this)
		}

		render () {
			return (
				<table id="idtable"> 
					<tbody>
						<tr id="tr1">
							<th>Lektor</th>
							<th>Kurs</th>
							<th>Kurskod</th>
							<th>Period</th>
						</tr>
						{this.state.isUndefined && <TableData />}
					</tbody>
				</table>
			)
		}
    }
    
	class Container extends React.Component {
		render () {
			return (
				<div className="table-container">
					<div className="table">
						<Table />
					</div>
					<div className="table">
						<HourTable />
					</div>
				</div>
			)
		}
	}

        ReactDOM.render(
			<div id="container-main">
				<SelectContainer />
				<Container />
			</div>,
            document.getElementById("root")
        );


</script>



<br>
</body>
</html>